# CogniRename 技術スタック定義

## プロジェクト概要

- **対象規模**: 200 人・7000 枚（学習済み 2000 枚 + 処理対象 5000 枚）
- **用途**: 個人写真管理・大量リネーム自動化
- **アーキテクチャ**: モジュラー設計（CUI/GUI 両対応）

---

## コア技術

### 言語・フレームワーク

| 技術          | バージョン | 用途               | 理由                                   |
| ------------- | ---------- | ------------------ | -------------------------------------- |
| **Python**    | 3.11+      | メイン開発言語     | ML・画像処理ライブラリが豊富           |
| **Click**     | 8.1+       | CLI フレームワーク | シンプルで直感的なコマンド定義         |
| **Streamlit** | 1.28+      | GUI フレームワーク | 迅速なプロトタイピング・画像表示に最適 |

### 顔認識・画像処理

| ライブラリ           | バージョン | 用途                 | 特記事項              |
| -------------------- | ---------- | -------------------- | --------------------- |
| **face_recognition** | 1.3+       | 顔検出・特徴量抽出   | dlib ベース・高精度   |
| **dlib**             | 19.24+     | 機械学習バックエンド | face_recognition 依存 |
| **opencv-python**    | 4.8+       | 画像前処理           | 高速・汎用的          |
| **Pillow (PIL)**     | 10.0+      | 画像 I/O             | 多フォーマット対応    |
| **numpy**            | 1.24+      | 数値計算             | 特徴量ベクトル操作    |

### データベース・永続化

| 技術        | バージョン     | 用途         | 設計考慮点                           |
| ----------- | -------------- | ------------ | ------------------------------------ |
| **SQLite**  | 3.40+          | 顔データ管理 | 軽量・ファイルベース・個人利用に最適 |
| **sqlite3** | 標準ライブラリ | DB 接続      | Python 標準・追加依存なし            |

---

## 性能・スケーラビリティ考慮

### 大量データ処理対応

- **並列処理**: `concurrent.futures` で顔認識並列化
- **メモリ効率**: 画像を逐次処理・一括ロード回避
- **プログレス表示**: `tqdm` (CLI) / Streamlit プログレスバー (GUI)

### 顔認識最適化

| 項目          | 設定  | 理由                     |
| ------------- | ----- | ------------------------ |
| **tolerance** | 0.6   | 200 人規模で誤認識を抑制 |
| **model**     | 'hog' | CPU 効率優先（GPU 不要） |
| **upsample**  | 1     | 精度と速度のバランス     |

---

## 開発・運用支援

### テスト・品質管理

| ツール     | バージョン | 用途               |
| ---------- | ---------- | ------------------ |
| **pytest** | 7.4+       | 単体・統合テスト   |
| **black**  | 23.0+      | コードフォーマット |
| **flake8** | 6.0+       | 静的解析           |
| **mypy**   | 1.5+       | 型チェック         |

### パッケージ管理

| ファイル             | 用途       | 管理方式           |
| -------------------- | ---------- | ------------------ |
| **pyproject.toml**   | メイン設定 | PEP 621 準拠       |
| **requirements.txt** | 依存関係   | 厳密バージョン固定 |

### CI/CD・デプロイ

| 技術               | 用途       | 備考                       |
| ------------------ | ---------- | -------------------------- |
| **GitHub Actions** | 自動テスト | Python マトリックステスト  |
| **Docker**         | 環境統一   | オプション（必要に応じて） |

---

## ファイル・データ形式

### 対応画像フォーマット

- **主要**: JPEG, PNG, WebP, JFIF
- **その他**: Pillow 対応全形式
- **制約**: 最大サイズ 50MB（メモリ考慮）

### データベーススキーマ

```sql
-- persons: 人物マスタ
CREATE TABLE persons (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT UNIQUE NOT NULL
);

-- face_encodings: 顔特徴量
CREATE TABLE face_encodings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    person_id INTEGER NOT NULL,
    encoding BLOB NOT NULL,
    FOREIGN KEY (person_id) REFERENCES persons (id)
);
```

---

## セキュリティ・プライバシー考慮

### データ保護

- **ローカル処理**: クラウドアップロード無し
- **顔データ暗号化**: SQLite 暗号化オプション検討
- **個人情報管理**: 顔特徴量のみ保存・元画像は保持しない

### 運用制限

- **個人利用限定**: 商用利用は想定外
- **法的配慮**: 肖像権・プライバシー配慮をドキュメント化

---

## パフォーマンス目標

### 処理速度目安（CPU: 中程度）

| 処理               | 目標時間      | 備考           |
| ------------------ | ------------- | -------------- |
| 顔検出・特徴量抽出 | 1 ～ 3 秒/枚  | 画像サイズ依存 |
| DB 照合（200 人）  | 0.1 秒/顔     | NumPy 最適化   |
| リネーム処理       | 5000 枚/30 分 | 並列処理時     |

### メモリ使用量

- **通常時**: 100MB 以下
- **大量処理時**: 500MB 以下（バッチサイズ制御）

---

## 将来拡張検討

### 機能拡張候補

- 顔認識モデルの切り替え対応
- 命名規則のカスタマイズ
- 人物管理 UI（統合・削除）
- 認識精度レポート機能

### 技術負債対策

- モジュール間の疎結合維持
- 設定外部化（config.py 中心）
- テストカバレッジ 80%以上維持
